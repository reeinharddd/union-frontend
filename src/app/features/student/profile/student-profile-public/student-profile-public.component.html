<div
  class="max-w-4x2 mx-auto overflow-hidden rounded-2xl bg-white shadow-xl dark:bg-gray-800"
  *ngIf="student(); else loadingOrError"
>
  <!-- ✅ Header del perfil con foto y datos básicos según REQ-4.22.4 -->
  <div class="relative bg-[#EB6228] px-6 py-8">
    <div
      class="flex flex-col items-center space-y-4 md:flex-row md:items-start md:justify-between md:space-x-6 md:space-y-0"
    >
      <!-- Contenedor izquierdo: Avatar + Información básica -->
      <div class="flex flex-col items-center space-y-4 md:flex-row md:space-x-6 md:space-y-0">
        <!-- Avatar del estudiante -->
        <div class="relative">
          <!-- <div class="w-32 h-32 rounded-full bg-white shadow-lg flex items-center justify-center neo-shadow"> -->
          <!-- <img [src]="student()?.avatar || 'assets/default-avatar.png'" 
                 [alt]="(student()?.nombre || '') + ' ' + (student()?.apellido || '')"
                 class="w-28 h-28 rounded-full object-cover"> -->
          <!-- </div> -->

          <!-- Insignia de verificación según REQ-4.2.2 -->
          <!-- <div class="absolute -bottom-2 -right-2 bg-green-500 rounded-full p-2 shadow-lg">
            <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
          </div> -->
        </div>

        <!-- Información básica del estudiante -->
        <div class="text-center text-white md:text-left">
          <h1 class="mb-2 text-3xl font-bold">
            {{ student()?.nombre }}
          </h1>

          <!-- Estado académico según REQ-4.2.2 -->
          <div class="mb-3 flex items-center justify-center space-x-2 md:justify-start">
            <span class="rounded-full bg-white/20 px-3 py-1 text-sm font-medium">
              {{ student()?.rol_id === 2 ? 'Estudiante' : 'Egresado' }}
            </span>
            <!-- <span class="px-3 py-1 bg-white/20 rounded-full text-sm font-medium">
              {{getGraduationYear()}}
            </span> -->
          </div>

          <!-- Universidad según REQ-4.6.1 -->
          <div class="flex items-center justify-center space-x-2 md:justify-start">
            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path
                d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"
              />
            </svg>
            <span class="font-medium">{{ university()?.nombre }}</span>
          </div>
        </div>
      </div>

      <!-- Contenedor derecho: Estadísticas y botones de acción -->
      <div class="flex flex-col items-center space-y-4 md:items-end">
        <!-- Estadísticas -->
        <div class="grid grid-cols-2 gap-4 text-center text-white">
          <div>
            <div class="text-2xl font-bold">{{ projectsCount() }}</div>
            <div class="text-sm opacity-80">Proyectos</div>
          </div>
          <div>
            <div class="text-2xl font-bold">{{ connectionsCount() }}</div>
            <div class="text-sm opacity-80">Seguidores</div>
          </div>
        </div>

        <!-- Botones de acción (si no es perfil propio) -->
        <div class="flex space-x-3" *ngIf="!isOwnProfile()">
          <button
            (click)="followUser(student()?.id!)"
            [disabled]="loading()"
            class="rounded-lg bg-white/20 px-4 py-2 text-sm font-medium text-white backdrop-blur-sm transition-all duration-200 hover:bg-white/30 disabled:opacity-50"
            [title]="
              isFollowing() ? 'Click para dejar de seguir' : 'Click para seguir a este usuario'
            "
            [ngClass]="{ 'bg-green-500/30 hover:bg-green-500/40': isFollowing() }"
          >
            <span class="flex items-center space-x-2">
              <!-- Icono dinámico según estado de seguimiento -->
              <svg
                class="h-4 w-4 transition-all duration-200"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <!-- Icono para seguir (usuario + plus) -->
                <path
                  *ngIf="!isFollowing()"
                  d="M8 9a3 3 0 100-6 3 3 0 000 6zM8 11a6 6 0 016 6H2a6 6 0 016-6zM16 7a1 1 0 10-2 0v1h-1a1 1 0 100 2h1v1a1 1 0 102 0v-1h1a1 1 0 100-2h-1V7z"
                />
                <!-- Icono para siguiendo (check) -->
                <path
                  *ngIf="isFollowing()"
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>

              <!-- Texto dinámico -->
              <span>{{ isFollowing() ? 'Siguiendo' : 'Seguir' }}</span>

              <!-- Indicador de carga cuando está procesando -->
              <svg
                *ngIf="loading()"
                class="ml-1 h-4 w-4 animate-spin"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
            </span>
          </button>

          <!-- <button (click)="startConversation(student()?.id!)"
                  class="px-4 py-2 bg-white text-[#EB6228] rounded-lg font-medium hover:bg-gray-100 transition-all duration-200 text-sm">
            Mensaje
          </button> -->
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ Cuerpo del perfil con información detallada -->
  <div class="space-y-8 p-6">
    <!-- Biografía/Descripción personal -->
    <div class="neo-inset rounded-xl bg-gray-50 p-6 dark:bg-gray-700">
      <h2 class="mb-4 flex items-center text-xl font-semibold text-gray-800 dark:text-gray-200">
        <svg class="mr-2 h-6 w-6 text-[#EB6228]" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0010 11z"
            clip-rule="evenodd"
          />
        </svg>
        Acerca de
      </h2>
      <p class="leading-relaxed text-gray-600 dark:text-gray-300">
        {{ student()?.biografia || 'Este estudiante aún no ha agregado una descripción personal.' }}
      </p>
    </div>

    <!-- ✅ Experiencias académicas/profesionales según REQ-4.22.1 -->
    <div class="neo-inset rounded-xl bg-gray-50 p-6 dark:bg-gray-700">
      <h2 class="mb-6 flex items-center text-xl font-semibold text-gray-800 dark:text-gray-200">
        <svg class="mr-2 h-6 w-6 text-[#EB6228]" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"
            clip-rule="evenodd"
          />
          <path
            d="M2 13.692V16a2 2 0 002 2h12a2 2 0 002-2v-2.308A24.974 24.974 0 0110 15c-2.796 0-5.487-.46-8-1.308z"
          />
        </svg>
        Experiencia Profesional
      </h2>

      <!-- Lista de experiencias según REQ-4.22.3 y REQ-4.22.4 -->
      <div class="space-y-4" *ngIf="experiences().length > 0; else noExperiences">
        <div
          *ngFor="let experience of experiences()"
          class="rounded-r-lg border-l-4 border-[#EB6228] bg-white py-3 pl-4 shadow-sm dark:bg-gray-600"
        >
          <div class="mb-2 flex items-start justify-between">
            <h3 class="font-semibold text-gray-800 dark:text-gray-200">
              {{ experience.titulo }}
            </h3>
            <span
              class="rounded bg-gray-100 px-2 py-1 text-sm text-gray-500 dark:bg-gray-700 dark:text-gray-400"
            >
              {{ experience.fecha_inicio | date: 'MMM yyyy' }} -
              {{ experience.fecha_fin ? (experience.fecha_fin | date: 'MMM yyyy') : 'Actual' }}
            </span>
          </div>
          <p class="mb-2 font-medium text-[#EB6228]">{{ experience.tipo }}</p>
          <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">
            {{ experience.descripcion }}
          </p>
        </div>
      </div>

      <ng-template #noExperiences>
        <div class="py-8 text-center text-gray-500 dark:text-gray-400">
          <svg class="mx-auto mb-4 h-12 w-12 opacity-50" fill="currentColor" viewBox="0 0 20 20">
            <path
              fill-rule="evenodd"
              d="M6 6V5a3 3 0 013-3h2a3 3 0 013 3v1h2a2 2 0 012 2v3.57A22.952 22.952 0 0110 13a22.95 22.95 0 01-8-1.43V8a2 2 0 012-2h2zm2-1a1 1 0 011-1h2a1 1 0 011 1v1H8V5zm1 5a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z"
              clip-rule="evenodd"
            />
          </svg>
          <p>No hay experiencias profesionales registradas</p>
        </div>
      </ng-template>
    </div>

    <!-- ✅ Proyectos académicos según REQ-4.8.1 -->
    <div class="neo-inset rounded-xl bg-gray-50 p-6 dark:bg-gray-700">
      <h2 class="mb-6 flex items-center text-xl font-semibold text-gray-800 dark:text-gray-200">
        <svg class="mr-2 h-6 w-6 text-[#EB6228]" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
          />
        </svg>
        Proyectos Académicos
      </h2>

      <div class="grid gap-4 md:grid-cols-2" *ngIf="projects().length > 0; else noProjects">
        <div
          *ngFor="let project of projects()"
          class="neo-shadow cursor-pointer rounded-lg bg-white p-4 shadow-sm transition-shadow hover:shadow-md dark:bg-gray-600"
          (click)="viewProject(project.id)"
        >
          <!-- Insignia de verificación según REQ-4.10.2 -->
          <div class="mb-3 flex items-start justify-between">
            <h3 class="flex-1 font-semibold text-gray-800 dark:text-gray-200">
              {{ project.nombre }}
            </h3>
            <span
              *ngIf="project.verificado"
              class="ml-2 flex items-center rounded-full bg-green-100 px-2 py-1 text-xs text-green-800"
            >
              <svg class="mr-1 h-3 w-3" fill="currentColor" viewBox="0 0 20 20">
                <path
                  fill-rule="evenodd"
                  d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                  clip-rule="evenodd"
                />
              </svg>
              Verificado
            </span>
          </div>

          <p class="mb-3 line-clamp-2 text-sm text-gray-600 dark:text-gray-300">
            {{ project.descripcion }}
          </p>

          <!-- Tecnologías usadas -->
          <div class="mb-3 flex flex-wrap gap-1" *ngIf="project.tecnologias">
            <span
              *ngFor="let tech of project.tecnologias.split(',')"
              class="rounded bg-[#EB6228]/10 px-2 py-1 text-xs text-[#EB6228]"
            >
              {{ tech.trim() }}
            </span>
          </div>

          <!-- Estado del proyecto según REQ-4.9.2 -->
          <div class="flex items-center justify-between text-sm">
            <span class="text-gray-500 dark:text-gray-400">
              {{ project.creado_en | date: 'MMM yyyy' }}
            </span>
            <span
              [ngClass]="{
                'bg-green-100 text-green-800': project.estado === 'activo',
                'bg-yellow-100 text-yellow-800': project.estado === 'pausado',
                'bg-gray-100 text-gray-800': project.estado === 'cerrado',
              }"
              class="rounded-full px-2 py-1 text-xs font-medium"
            >
              {{ project.estado | titlecase }}
            </span>
          </div>
        </div>
      </div>

      <ng-template #noProjects>
        <div class="py-8 text-center text-gray-500 dark:text-gray-400">
          <svg class="mx-auto mb-4 h-12 w-12 opacity-50" fill="currentColor" viewBox="0 0 20 20">
            <path
              d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
            />
          </svg>
          <p>No hay proyectos académicos registrados</p>
        </div>
      </ng-template>
    </div>

    <!-- ✅ Habilidades y competencias -->
    <div class="neo-inset rounded-xl bg-gray-50 p-6 dark:bg-gray-700">
      <h2 class="mb-6 flex items-center text-xl font-semibold text-gray-800 dark:text-gray-200">
        <svg class="mr-2 h-6 w-6 text-[#EB6228]" fill="currentColor" viewBox="0 0 20 20">
          <path
            d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
          />
        </svg>
        Habilidades y Competencias
      </h2>

      <div class="flex flex-wrap gap-2" *ngIf="getStudentSkills().length > 0; else noSkills">
        <span
          *ngFor="let skill of getStudentSkills()"
          class="neo-shadow rounded-full bg-[#EB6228] px-3 py-2 text-sm font-medium text-white"
        >
          {{ skill }}
        </span>
      </div>

      <ng-template #noSkills>
        <div class="py-8 text-center text-gray-500 dark:text-gray-400">
          <svg class="mx-auto mb-4 h-12 w-12 opacity-50" fill="currentColor" viewBox="0 0 20 20">
            <path
              d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"
            />
          </svg>
          <p>No se han registrado habilidades específicas</p>
        </div>
      </ng-template>
    </div>

    <!-- ✅ Actividad reciente en foros según REQ-4.19.1 -->
    <!-- <div class="bg-gray-50 dark:bg-gray-700 rounded-xl p-6 neo-inset">
      <h2 class="text-xl font-semibold text-gray-800 dark:text-gray-200 mb-6 flex items-center">
        <svg class="w-6 h-6 mr-2 text-[#EB6228]" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z" clip-rule="evenodd"/>
        </svg>
        Actividad en Foros
      </h2> -->

    <!-- <div class="space-y-3" *ngIf="forumActivity().length > 0; else noActivity">
        <div *ngFor="let activity of forumActivity(); trackBy: trackActivityBy" 
             class="flex items-start space-x-3 p-3 bg-white dark:bg-gray-600 rounded-lg border-l-4"
             [ngClass]="{
               'border-green-400': activity.tipo === 'hilo',
               'border-blue-400': activity.tipo === 'respuesta'
             }"> -->

    <!-- ✅ Debug info (remover en producción) -->
    <!-- <div class="text-xs text-red-500 absolute top-0 right-0 p-1 bg-yellow-100 rounded z-10">
            <div>Tipo: {{activity.tipo}}</div>
            <div>ID: {{activity.id}}</div>
            <div>Título: {{activity.titulo || 'N/A'}}</div>
            <div>Hilo_ID: {{activity.hilo_id || 'N/A'}}</div>
          </div> -->

    <!-- ✅ Icono diferente según tipo de actividad -->
    <!-- <div class="flex-shrink-0 mt-1">
            <div *ngIf="activity.tipo === 'hilo'" 
                 class="w-8 h-8 bg-green-100 dark:bg-green-800 rounded-full flex items-center justify-center">
              <span class="text-green-600 dark:text-green-300 text-sm font-bold">📝</span>
            </div>
            <div *ngIf="activity.tipo === 'respuesta'" 
                 class="w-8 h-8 bg-blue-100 dark:bg-blue-800 rounded-full flex items-center justify-center">
              <span class="text-blue-600 dark:text-blue-300 text-sm font-bold">💬</span>
            </div>
          </div> -->

    <!-- <div class="flex-1 relative"> -->
    <!-- ✅ Hilo creado -->
    <!-- <div *ngIf="activity.tipo === 'hilo'; else respuestaTemplate">
              <div class="flex items-center space-x-2 mb-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-800 dark:text-green-100">
                  📋 Creó un foro de discusión
                </span>
              </div>
              <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">
                "{{activity.titulo}}"
              </h4>
              <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 bg-gray-50 dark:bg-gray-700 p-2 rounded">
                {{activity.contenido}}
              </p>
            </div> -->

    <!-- ✅ Respuesta/comentario -->
    <!-- <ng-template #respuestaTemplate>
              <div class="flex items-center space-x-2 mb-2">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-800 dark:text-blue-100">
                  � Respondió en un hilo
                </span>
              </div>
              <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 bg-blue-50 dark:bg-blue-900/20 p-2 rounded border-l-2 border-blue-300">
                <em>"{{activity.contenido}}"</em>
              </p>
            </ng-template>

            <div class="flex items-center justify-between mt-3 pt-2 border-t border-gray-200 dark:border-gray-600">
              <p class="text-xs text-gray-500 dark:text-gray-400 flex items-center">
                🕒 {{activity.creado_en | date:'medium'}}
              </p>
              <span class="text-xs px-2 py-1 rounded-full"
                    [ngClass]="{
                      'bg-green-100 text-green-600': activity.tipo === 'hilo',
                      'bg-blue-100 text-blue-600': activity.tipo === 'respuesta'
                    }">
                {{activity.tipo === 'hilo' ? 'Foro Creado' : 'Comentario'}}
              </span> -->
    <!-- </div>
          </div>
        </div>
      </div> -->

    <ng-template #noActivity>
      <div class="py-8 text-center text-gray-500 dark:text-gray-400">
        <svg class="mx-auto mb-4 h-12 w-12 opacity-50" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z"
            clip-rule="evenodd"
          />
        </svg>
        <p>No hay actividad reciente en foros</p>
      </div>
    </ng-template>
  </div>
</div>
<!-- </div> -->

<!-- Template de loading/error -->
<ng-template #loadingOrError>
  <div
    class="mx-auto max-w-4xl overflow-hidden rounded-2xl bg-white p-8 shadow-xl dark:bg-gray-800"
  >
    <div class="text-center" *ngIf="loading(); else errorTemplate">
      <div
        class="mx-auto mb-4 h-12 w-12 animate-spin rounded-full border-b-2 border-[#EB6228]"
      ></div>
      <p class="text-gray-600 dark:text-gray-300">Cargando perfil...</p>
    </div>

    <ng-template #errorTemplate>
      <div class="text-center text-red-500">
        <svg class="mx-auto mb-4 h-12 w-12" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
            clip-rule="evenodd"
          />
        </svg>
        <p class="mb-2 text-lg font-medium">Error al cargar el perfil</p>
        <p class="text-sm">{{ error() }}</p>
        <button
          (click)="goBack()"
          class="hover:bg-orange-600 mt-4 rounded-lg bg-[#EB6228] px-4 py-2 text-white transition-colors"
        >
          Volver
        </button>
      </div>
    </ng-template>
  </div>
</ng-template>
