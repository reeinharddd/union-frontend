<!-- Fabian Mendoza -->
<!-- Botón y formulario para añadir bloque -->
<div class="relative mb-6">
  <button
    *ngIf="canEdit && !showCreate()"
    type="button"
    (click)="showCreate.set(true)"
    style="top: -50px"
    class="absolute right-2 z-10 rounded-full border border-primary-200 bg-primary-500 p-2 text-xs font-bold text-white shadow-md transition-all duration-150 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-200"
    title="Añadir bloque"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      class="h-4 w-4"
      fill="none"
      viewBox="0 0 24 24"
      stroke="currentColor"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
    </svg>
  </button>

  <!-- Formulario de creación de bloque -->
  <div
    *ngIf="canEdit && showCreate()"
    class="mt-8 space-y-4 rounded-2xl border bg-white p-4 shadow-lg"
  >
    <div class="flex items-center space-x-4">
      <label class="font-semibold text-black">
        Tipo:
        <select [(ngModel)]="newType" class="bg-gray-50 ml-2 rounded border p-1 text-black">
          <option value="texto">Texto</option>
          <option value="video">Vídeo</option>
          <option value="embed">Embed</option>
          <!-- <option value="imagen">Imagen</option> -->
        </select>
      </label>
    </div>

    <!-- Controles dinámicos según el tipo -->
    <div *ngIf="newType() === 'texto'">
      <textarea
        [(ngModel)]="newText"
        placeholder="Contenido de texto"
        class="bg-gray-50 w-full rounded border p-3 text-black"
      ></textarea>
    </div>
    <div *ngIf="newType() === 'video'">
      <input
        [(ngModel)]="newVideoUrl"
        placeholder="URL de vídeo"
        class="bg-gray-50 w-full rounded border p-3 text-black"
      />
    </div>
    <div *ngIf="newType() === 'embed'">
      <input
        [(ngModel)]="newEmbedUrl"
        placeholder="URL embebida"
        class="bg-gray-50 w-full rounded border p-3 text-black"
      />
    </div>
    <!-- <div *ngIf="newType() === 'image'">
      <input
        type="file"
        accept="image/*"
        (change)="onFileSelected($event)"
        class="block w-full mb-2"
      />
      <div *ngIf="previewUrl" class="mb-2">
        <img [src]="previewUrl" class="max-h-40 rounded shadow border" alt="Previsualización" />
      </div>
    </div> -->

    <div class="flex gap-4">
      <button
        type="button"
        (click)="add()"
        [disabled]="
          (newType() === 'texto' && !newText()) ||
          (newType() === 'video' && !newVideoUrl()) ||
          (newType() === 'embed' && !newEmbedUrl())
        "
        class="disabled:bg-gray-300 disabled:text-gray-500 flex items-center justify-center rounded-2xl border-2 border-primary-200 bg-primary-500 px-8 py-3 text-lg font-bold text-white shadow-xl transition-all duration-150 hover:bg-primary-700 focus:outline-none focus:ring-4 focus:ring-primary-200"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="mr-2 h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 4v16m8-8H4"
          />
        </svg>
        Guardar bloque
      </button>
      <button
        type="button"
        (click)="showCreate.set(false)"
        class="rounded-2xl bg-neutral-300 px-4 py-2 font-semibold text-black transition hover:bg-neutral-400"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>

<!-- GRID de bloques ligados a la página actual -->
<div
  cdkDropList
  (cdkDropListDropped)="drop($event)"
  class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3"
>
  <div
    *ngFor="let b of blocks()"
    cdkDrag
    [ngClass]="[
      'group relative rounded-2xl border bg-white p-4 shadow transition-all duration-150',
      getBlockWidthClass(b),
    ]"
  >
    <!-- Icono de mover -->
    <span
      class="absolute left-2 top-2 cursor-move text-primary-400"
      cdkDragHandle
      title="Arrastrar para mover"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <circle cx="6" cy="6" r="1.5" />
        <circle cx="6" cy="12" r="1.5" />
        <circle cx="6" cy="18" r="1.5" />
        <circle cx="12" cy="6" r="1.5" />
        <circle cx="12" cy="12" r="1.5" />
        <circle cx="12" cy="18" r="1.5" />
        <circle cx="18" cy="6" r="1.5" />
        <circle cx="18" cy="12" r="1.5" />
        <circle cx="18" cy="18" r="1.5" />
      </svg>
    </span>

    <!-- Icono para cambiar ancho -->
    <span
      class="absolute right-10 top-2 cursor-pointer text-primary-400"
      title="Cambiar ancho"
      (click)="toggleBlockWidth(b)"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <rect x="3" y="6" width="18" height="12" rx="2" stroke-width="2" />
        <path stroke-width="2" d="M9 6v12M15 6v12" />
      </svg>
    </span>

    <!-- Icono menú de acciones -->
    <span
      class="block-options-btn absolute right-2 top-2 cursor-pointer text-primary-400"
      (click)="toggleActionMenu(b)"
      title="Más acciones"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-5 w-5"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <circle cx="5" cy="12" r="1.5" />
        <circle cx="12" cy="12" r="1.5" />
        <circle cx="19" cy="12" r="1.5" />
      </svg>
    </span>
    <!-- Menú de acciones -->
    <div
      *ngIf="menuBlockId() === b.id"
      class="block-options-menu absolute right-2 top-8 z-20 min-w-[120px] rounded border bg-white shadow-md"
      (mouseleave)="closeMenu()"
    >
      <button
        type="button"
        (click)="editBlock(b); closeActionMenu()"
        class="hover:bg-gray-100 w-full px-4 py-2 text-left text-primary-700"
      >
        Editar
      </button>
      <button
        type="button"
        (click)="confirmDeleteBlock(b)"
        class="hover:bg-gray-100 w-full px-4 py-2 text-left text-accent-700"
      >
        Eliminar
      </button>
    </div>

    <div class="flex-1 pl-8 pr-4">
      <ng-container [ngSwitch]="b.tipo">
        <p *ngSwitchCase="'texto'" class="whitespace-pre-wrap text-black">
          {{ b.contenido['text']! }}
        </p>

        <!-- VIDEO -->
        <ng-container *ngSwitchCase="'video'">
          <ng-container *ngIf="isEmbeddable(b.contenido['videoUrl']!); else videoBlocked">
            <iframe
              [src]="getEmbeddableUrl(b.contenido['videoUrl']!) | safeUrl"
              class="h-48 w-full rounded-lg"
              frameborder="0"
              allowfullscreen
            >
            </iframe>
          </ng-container>
          <ng-template #videoBlocked>
            <div
              class="bg-yellow-100 border-yellow-400 rounded border p-4 font-semibold text-primary-700"
            >
              No es posible mostrar este video embebido por restricciones del sitio de origen.
            </div>
          </ng-template>
        </ng-container>

        <!-- EMBED -->
        <ng-container *ngSwitchCase="'embed'">
          <ng-container *ngIf="isEmbeddable(b.contenido['embedUrl']!); else embedBlocked">
            <iframe
              [src]="getEmbeddableUrl(b.contenido['embedUrl']!) | safeUrl"
              class="h-48 w-full rounded-lg"
              frameborder="0"
              allowfullscreen
            >
            </iframe>
          </ng-container>
          <ng-template #embedBlocked>
            <div
              class="bg-yellow-100 border-yellow-400 rounded border p-4 font-semibold text-primary-700"
            >
              No es posible mostrar este contenido embebido por restricciones del sitio de origen.
            </div>
          </ng-template>
        </ng-container>

        <!-- IMAGEN -->
        <img
          *ngSwitchCase="'imagen'"
          [src]="b.contenido['imageUrl']"
          class="border-gray-200 h-48 w-full rounded-xl border object-cover"
          alt="Imagen de bloque"
          (error)="onImgError($event)"
        />
      </ng-container>
    </div>
  </div>
</div>

<!-- Pop up de confirmación de borrado -->
<div
  *ngIf="showDeleteConfirm()"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40"
>
  <div class="max-w-sm rounded-2xl bg-white p-8 text-center shadow-xl">
    <p class="mb-4 text-lg font-bold text-accent-700">
      ¿Estás seguro de que deseas eliminar este bloque?
    </p>
    <div class="mt-6 flex justify-center gap-4">
      <button
        type="button"
        (click)="deleteConfirmed()"
        class="rounded-2xl bg-accent-500 px-6 py-2 font-semibold text-white hover:bg-accent-700"
      >
        Sí, eliminar
      </button>
      <button
        type="button"
        (click)="cancelDelete()"
        class="rounded-2xl bg-neutral-300 px-6 py-2 font-semibold text-black hover:bg-neutral-400"
      >
        Cancelar
      </button>
    </div>
  </div>
</div>
