<!-- Fabian Mendoza -->
<!-- Botón y formulario para añadir bloque -->
<div class="relative mb-6">
  <button
    *ngIf="canEdit && !showCreate()"
    type="button"
    (click)="showCreate.set(true)"
    style="top: -50px;"
    class="
      absolute right-2
      bg-primary-500 hover:bg-primary-700
      text-white text-xs font-bold
      rounded-full shadow-md
      p-2
      transition-all duration-150
      focus:outline-none focus:ring-2 focus:ring-primary-200
      border border-primary-200
      z-10
    "
    title="Añadir bloque"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
      viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round"
        stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
    </svg>
  </button>

  <!-- Formulario de creación de bloque -->
  <div *ngIf="canEdit && showCreate()" class="p-4 bg-white border rounded-2xl shadow-lg space-y-4 mt-8">
    <div class="flex items-center space-x-4">
      <label class="text-black font-semibold">
        Tipo:
        <select [(ngModel)]="newType" class="ml-2 p-1 border rounded bg-gray-50 text-black">
          <option value="texto">Texto</option>
          <option value="video">Vídeo</option>
          <option value="embed">Embed</option>
          <!-- <option value="imagen">Imagen</option> -->
        </select>
      </label>
    </div>

    <!-- Controles dinámicos según el tipo -->
    <div *ngIf="newType() === 'texto'">
      <textarea
        [(ngModel)]="newText"
        placeholder="Contenido de texto"
        class="w-full p-3 border rounded bg-gray-50 text-black"
      ></textarea>
    </div>
    <div *ngIf="newType() === 'video'">
      <input
        [(ngModel)]="newVideoUrl"
        placeholder="URL de vídeo"
        class="w-full p-3 border rounded bg-gray-50 text-black"
      />
    </div>
    <div *ngIf="newType() === 'embed'">
      <input
        [(ngModel)]="newEmbedUrl"
        placeholder="URL embebida"
        class="w-full p-3 border rounded bg-gray-50 text-black"
      />
    </div>
    <!-- <div *ngIf="newType() === 'image'">
      <input
        type="file"
        accept="image/*"
        (change)="onFileSelected($event)"
        class="block w-full mb-2"
      />
      <div *ngIf="previewUrl" class="mb-2">
        <img [src]="previewUrl" class="max-h-40 rounded shadow border" alt="Previsualización" />
      </div>
    </div> -->

    <div class="flex gap-4">
      <button
        type="button"
        (click)="add()"
        [disabled]="
          (newType() === 'texto' && !newText()) ||
          (newType() === 'video' && !newVideoUrl()) ||
          (newType() === 'embed' && !newEmbedUrl())
        "
        class="
          flex items-center justify-center
          bg-primary-500 hover:bg-primary-700
          text-white text-lg font-bold
          rounded-2xl shadow-xl
          px-8 py-3
          transition-all duration-150
          focus:outline-none focus:ring-4 focus:ring-primary-200
          disabled:bg-gray-300 disabled:text-gray-500
          border-2 border-primary-200
        "
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none"
          viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round"
            stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
        </svg>
        Guardar bloque
      </button>
      <button
        type="button"
        (click)="showCreate.set(false)"
        class="px-4 py-2 rounded-2xl bg-neutral-300 text-black font-semibold hover:bg-neutral-400 transition"
      >Cancelar</button>
    </div>
  </div>
</div>

<!-- GRID de bloques ligados a la página actual -->
<div
  cdkDropList
  (cdkDropListDropped)="drop($event)"
  class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
>
  <div
    *ngFor="let b of blocks()"
    cdkDrag
    [ngClass]="[
      'relative p-4 bg-white border rounded-2xl shadow group transition-all duration-150',
      getBlockWidthClass(b)
    ]"
  >
    <!-- Icono de mover -->
    <span class="absolute top-2 left-2 text-primary-400 cursor-move" cdkDragHandle title="Arrastrar para mover">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <circle cx="6" cy="6" r="1.5"/>
        <circle cx="6" cy="12" r="1.5"/>
        <circle cx="6" cy="18" r="1.5"/>
        <circle cx="12" cy="6" r="1.5"/>
        <circle cx="12" cy="12" r="1.5"/>
        <circle cx="12" cy="18" r="1.5"/>
        <circle cx="18" cy="6" r="1.5"/>
        <circle cx="18" cy="12" r="1.5"/>
        <circle cx="18" cy="18" r="1.5"/>
      </svg>
    </span>

    <!-- Icono para cambiar ancho -->
    <span
      class="absolute top-2 right-10 text-primary-400 cursor-pointer"
      title="Cambiar ancho"
      (click)="toggleBlockWidth(b)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <rect x="3" y="6" width="18" height="12" rx="2" stroke-width="2"/>
        <path stroke-width="2" d="M9 6v12M15 6v12"/>
      </svg>
    </span>

    <!-- Icono menú de acciones -->
    <span
      class="absolute top-2 right-2 text-primary-400 cursor-pointer block-options-btn"
      (click)="toggleActionMenu(b)"
      title="Más acciones"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
        viewBox="0 0 24 24" stroke="currentColor">
        <circle cx="5" cy="12" r="1.5"/>
        <circle cx="12" cy="12" r="1.5"/>
        <circle cx="19" cy="12" r="1.5"/>
      </svg>
    </span>
    <!-- Menú de acciones -->
  <div
    *ngIf="menuBlockId() === b.id"
    class="absolute top-8 right-2 bg-white border rounded shadow-md z-20 min-w-[120px] block-options-menu"
    (mouseleave)="closeMenu()"
  >
    <button
      type="button"
      (click)="editBlock(b); closeActionMenu()"
      class="w-full text-left px-4 py-2 hover:bg-gray-100 text-primary-700"
    >Editar</button>
    <button
      type="button"
      (click)="confirmDeleteBlock(b)"
      class="w-full text-left px-4 py-2 hover:bg-gray-100 text-accent-700"
    >Eliminar</button>
  </div>


    <div class="flex-1 pl-8 pr-4">
      <ng-container [ngSwitch]="b.tipo">
        <p *ngSwitchCase="'texto'" class="whitespace-pre-wrap text-black">
          {{ b.contenido['text']! }}
        </p>

        <!-- VIDEO -->
        <ng-container *ngSwitchCase="'video'">
          <ng-container *ngIf="isEmbeddable(b.contenido['videoUrl']!); else videoBlocked">
            <iframe
              [src]="getEmbeddableUrl(b.contenido['videoUrl']!) | safeUrl"
              class="w-full h-48 rounded-lg"
              frameborder="0"
              allowfullscreen>
            </iframe>
          </ng-container>
          <ng-template #videoBlocked>
            <div class="p-4 bg-yellow-100 border border-yellow-400 rounded text-primary-700 font-semibold">
              No es posible mostrar este video embebido por restricciones del sitio de origen.
            </div>
          </ng-template>
        </ng-container>

        <!-- EMBED -->
        <ng-container *ngSwitchCase="'embed'">
          <ng-container *ngIf="isEmbeddable(b.contenido['embedUrl']!); else embedBlocked">
            <iframe
              [src]="getEmbeddableUrl(b.contenido['embedUrl']!) | safeUrl"
              class="w-full h-48 rounded-lg"
              frameborder="0"
              allowfullscreen>
            </iframe>
          </ng-container>
          <ng-template #embedBlocked>
            <div class="p-4 bg-yellow-100 border border-yellow-400 rounded text-primary-700 font-semibold">
              No es posible mostrar este contenido embebido por restricciones del sitio de origen.
            </div>
          </ng-template>
        </ng-container>

        <!-- IMAGEN -->
        <img
          *ngSwitchCase="'imagen'"
          [src]="b.contenido['imageUrl']"
          class="w-full h-48 object-cover rounded-xl border border-gray-200"
          alt="Imagen de bloque"
          (error)="onImgError($event)"
        />
      </ng-container>
    </div>
  </div>
</div>

<!-- Pop up de confirmación de borrado -->
<div
  *ngIf="showDeleteConfirm()"
  class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50"
>
  <div class="bg-white rounded-2xl p-8 shadow-xl text-center max-w-sm">
    <p class="text-lg font-bold mb-4 text-accent-700">
      ¿Estás seguro de que deseas eliminar este bloque?
    </p>
    <div class="flex justify-center gap-4 mt-6">
      <button
        type="button"
        (click)="deleteConfirmed()"
        class="px-6 py-2 bg-accent-500 hover:bg-accent-700 text-white rounded-2xl font-semibold"
      >Sí, eliminar</button>
      <button
        type="button"
        (click)="cancelDelete()"
        class="px-6 py-2 bg-neutral-300 text-black rounded-2xl font-semibold hover:bg-neutral-400"
      >Cancelar</button>
    </div>
  </div>
</div>
